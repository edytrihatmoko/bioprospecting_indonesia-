<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OSM Point Collector (with Backend GeoJSON)</title>

<!-- Leaflet core -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet.draw -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<style>
  html, body { height:100%; margin:0; }
  #map { position:absolute; inset:0; }
  .toolbar, .leftbar {
    position: fixed; z-index: 1000; background:#fff;
    border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.15);
    padding:10px; font: 14px/1.3 system-ui, -apple-system,"Segoe UI",Roboto,Arial;
  }
  .toolbar { top: 10px; right: 10px; }
  .leftbar { top: 10px; left: 10px; }
  .toolbar button, .toolbar label, .leftbar button { margin: 4px 0; width: 100%; }
  .form-popup { min-width: 260px; font: 14px/1.3 system-ui, -apple-system,"Segoe UI",Roboto,Arial; }
  .form-popup input, .form-popup select, .form-popup textarea, .form-popup button {
    width: 100%; box-sizing: border-box; margin: 6px 0;
  }
  .small-note { font-size: 12px; color:#666; }
</style>
</head>
<body>

<div id="map"></div>

<div class="toolbar">
  <button id="uploadBtn">Upload GeoJSON to Backend</button>
  <button id="loadBackendBtn">Load GeoJSON from Backend</button>
  <div class="small-note">Backend data: <code>/api/geojson/*</code></div>
</div>
<script>
  var map = L.map('map').setView([23.7, 121.0], 7);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  var drawnItems   = new L.FeatureGroup().addTo(map);
  var sharedLayer  = new L.FeatureGroup().addTo(map);
  var myLocMarker = null, myLocCircle = null, lastCoords = null;

  var drawControl = new L.Control.Draw({
    draw: { marker: true, polygon: false, polyline: false, rectangle: false, circle: false, circlemarker: false },
    edit: { featureGroup: drawnItems }
  });
  map.addControl(drawControl);

  function buildForm(layer) {
    var props = (layer.feature && layer.feature.properties) || {};
    var title    = props.title    || "";
    var type     = props.type     || "Infrastructure";
    var category = props.category || "A";
    var notes    = props.notes    || "";

    var container = L.DomUtil.create('div', 'form-popup');
    container.innerHTML = `
      <label>Title
        <input type="text" id="f_title" placeholder="Point name" value="${title.replace(/"/g, '&quot;')}"/>
      </label>
      <label>Type
        <select id="f_type">
          <option value="Temu Lawak"${type==="Temu Lawak"?" selected":""}>Temu Lawak</option>
          <option value="Jahe"${type==="Jahe"?" selected":""}>Jahe</option>
          <option value="Lengkuas"${type==="Lengkuas"?" selected":""}>Lengkuas</option>
          <option value="Other"${type==="Other"?" selected":""}>Other</option>
        </select>
      </label>
      <label>Category
        <select id="f_category">
          <option value="A"${category==="A"?" selected":""}>A</option>
          <option value="B"${category==="B"?" selected":""}>B</option>
          <option value="C"${category==="C"?" selected":""}>C</option>
        </select>
      </label>
      <label>Notes
        <textarea id="f_notes" rows="4" placeholder="Description...">${notes.replace(/</g,"&lt;")}</textarea>
      </label>
      <button id="saveBtn">Save</button>
    `;
    L.DomEvent.disableClickPropagation(container);
    setTimeout(function(){
      container.querySelector('#saveBtn').addEventListener('click', function(){
        var t  = container.querySelector('#f_title').value.trim();
        var tp = container.querySelector('#f_type').value;
        var c  = container.querySelector('#f_category').value;
        var n  = container.querySelector('#f_notes').value.trim();
        layer.feature = layer.feature || { type: "Feature", properties: {} };
        layer.feature.properties = { title: t, type: tp, category: c, notes: n };
        var readonlyHTML = `
          <b>${t || '(no title)'}</b><br/>
          <b>Type:</b> ${tp}<br/>
          <b>Category:</b> ${c}<br/>
          <b>Notes:</b><br/>${(n || '(none)').replace(/\n/g,'<br/>')}
          <hr style="margin:8px 0"/>
          <button id="editBtn">Edit</button>
        `;
        layer.bindPopup(readonlyHTML).openPopup();
        setTimeout(function(){
          var editBtn = document.getElementById('editBtn');
          if (editBtn) editBtn.addEventListener('click', function(){
            m.bindPopup(buildForm(m)).openPopup();
          });
        }, 50);
      });
    }, 0);
    return container;
  }

  map.on(L.Draw.Event.CREATED, function (e) {
    var layer = e.layer;
    drawnItems.addLayer(layer);
    layer.bindPopup(buildForm(layer)).openPopup();
  });

  function uploadGeoJSONToBackend() {
    var features = [];
    drawnItems.eachLayer(function (layer) {
      if (layer instanceof L.Marker) {
        var ll = layer.getLatLng();
        var props = (layer.feature && layer.feature.properties) ? layer.feature.properties : {};
        features.push({ type:"Feature", geometry:{ type:"Point", coordinates:[ll.lng, ll.lat] }, properties: props });
      }
    });

    fetch('/api/geojson/update_all', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(features),
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error uploading GeoJSON: ' + data.error);
        } else {
            alert('GeoJSON data uploaded successfully: ' + data.message);
        }
    })
    .catch((error) => {
        console.error('Error:', error);
        alert('Failed to upload GeoJSON data: ' + error);
    });
  }
  document.getElementById('uploadBtn').addEventListener('click', uploadGeoJSONToBackend);

  // This function is no longer needed after backend integration if we replace local file import
  // document.getElementById('importFile').addEventListener('change', function(evt){/* ... */});

  function loadGeoJSONFromBackend() {
    fetch('/api/geojson/load', { cache: 'no-store' })
      .then(r => { if (!r.ok) throw new Error('Failed to load GeoJSON from backend'); return r.json(); })
      .then(data => {
        drawnItems.clearLayers(); // Clear existing drawn items before loading new ones
        sharedLayer.clearLayers(); // Clear any previously loaded shared data

        if (data.length > 0) {
          var geo = L.geoJSON(data, {
            pointToLayer: function(feature, latlng){
              var m = L.marker(latlng); m.feature = feature; // Attach feature to layer
              var p = feature.properties || {};
              var popupHtml = `
                <b>${p.title || '(no title)'}</b><br/>
                <b>Type:</b> ${p.type || '(n/a)'}<br/>
                <b>Category:</b> ${p.category || '(n/a)'}<br/>
                <b>Notes:</b><br/>${(p.notes || '(none)').replace(/\n/g,'<br/>')}
                <hr style="margin:8px 0"/>
                <button id="editBtn">Edit</button>
              `;
              m.bindPopup(popupHtml);
              m.on('popupopen', function(){
                setTimeout(function(){
                  var editBtn = document.getElementById('editBtn');
                  if (editBtn) editBtn.addEventListener('click', function(){
                    m.bindPopup(buildForm(m)).openPopup();
                  });
                }, 50);
              });
              return m;
            }
          });
          geo.eachLayer(function(l){ drawnItems.addLayer(l); }); // Add to drawnItems instead of sharedLayer
          try { map.fitBounds(geo.getBounds(), {padding:[20,20]}); } catch(e) {}
        } else {
            alert('No GeoJSON data found in backend.');
        }
      })
      .catch(err => {
          console.error('Backend load error:', err.message);
          alert('Failed to load GeoJSON from backend: ' + err.message);
      });
  }
  document.getElementById('loadBackendBtn').addEventListener('click', loadGeoJSONFromBackend);
  loadGeoJSONFromBackend(); // Load data on initial page load

  function showStatus(msg){ /* Placeholder for status display */ } // Remove actual element if not used
  function clearMyLocation(){ /* ... */ }
  function locateUser(setView=true){ /* ... */ }
  map.on('locationfound', function(e){ /* ... */ });
  map.on('locationerror', function(e){ /* ... */ });
  // document.getElementById('locateBtn').addEventListener('click', function(){ locateUser(true); });
  // document.getElementById('addHereBtn').addEventListener('click', function(){ /* ... */ });
</script>
</body>
</html>
